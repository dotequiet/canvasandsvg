<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="charset=text/html" charset="utf-8">
  <meta name="viewport" content="width=device-width minimum-scale=1.0 maximum-scale=1.0,user-scalable=no initial-scale=1">
  <title>刮刮卡</title>
  <style>
    html,body{
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    #scratch{
      width: 100%;
      height: 150px;
      background: url('//www.baidu.com/img/bd_logo1.png') no-repeat;
      background-size: 100% 100%;
    }
  </style>
</head>
<body>
  <div id="scratch">
  </div>

</body>
</html>
<script>
  function init(){
    var scratchCount = 0
    if(!document.querySelector('#canvas')){
      var canvasWidth = '';
      var canvasHeight = '';
      var canvas = document.createElement('canvas');
      width = document.getElementById("scratch").offsetWidth;
      height = document.getElementById("scratch").offsetHeight;
      canvas.setAttribute("width", width + "px");
      canvas.setAttribute("height", height + "px");
      canvas.id = "canvas";
      document.getElementById("scratch").appendChild(canvas);
    }
    var canvas = document.getElementById('canvas')
    var ctx = canvas.getContext("2d");
    //绘制黑色矩形
    ctx.beginPath();
    ctx.fillStyle = "#939393";
    ctx.rect(0, 0, width, height);
    ctx.closePath();
    ctx.fill();

    var canvasWidth = ctx.canvas.clientWidth
    var canvasHeight = ctx.canvas.clientHeight
    var isDown = false; //鼠标是否按下标志
    var pointerArr = []; //鼠标移动坐标数组
    var xPointer = 0;//鼠标当前x坐标
    var yPointer = 0;//鼠标当前y坐标

    //pc，移动事件兼容写法
    var hastouch = "ontouchstart" in window ? true : false,
    tapstart = hastouch ? "touchstart" : "mousedown",
    tapmove = hastouch ? "touchmove" : "mousemove",
    tapend = hastouch ? "touchend" : "mouseup";

    //鼠标按下
    canvas.addEventListener(tapstart, function(e) {
      this.style.cursor = "move";
      isDown = true;
      xPointer = hastouch ? e.targetTouches[0].pageX : e.clientX - this.offsetLeft;
      yPointer = hastouch ? e.targetTouches[0].pageY : e.clientY - this.offsetTop;;
      pointerArr.push([xPointer, yPointer]);
      circleReset(ctx);
    });

    //鼠标按下后拖动
    canvas.addEventListener(tapmove, function(e) {
      if (isDown) {
        xPointer = hastouch ? e.targetTouches[0].pageX : e.clientX - this.offsetLeft;;
        yPointer = hastouch ? e.targetTouches[0].pageY : e.clientY - this.offsetTop;;
        pointerArr.push([xPointer, yPointer]);
        circleReset(ctx);
      }
    });

    //鼠标抬起取消事件
    canvas.addEventListener(tapend, function(event) {
      scratchCount++
      isDown = false;
      pointerArr = [];
      if(scratchCount > 3)circleReset(ctx);
    });

    //圆形橡皮檫
    function circleReset(ctx) {
      ctx.save();
      ctx.beginPath();
      ctx.lineCap='round'; //设置线条两端为圆弧
      ctx.lineJoin='round'; //设置线条转折为圆弧　
      ctx.lineWidth = 60;
      if(scratchCount < 4){
        ctx.moveTo(pointerArr[0][0], pointerArr[0][1]);
        ctx.globalCompositeOperation = "destination-out";
        if (pointerArr.length == 1) {
          ctx.lineTo(pointerArr[0][0], pointerArr[0][1]);
        } else {
          for (var i=1;i<pointerArr.length;i++) {
            ctx.lineTo(pointerArr[i][0], pointerArr[i][1]);
            ctx.moveTo(pointerArr[i][0], pointerArr[i][1]);
          }
        }
      }else{
        ctx.clearRect(0, 0, canvasWidth, canvasHeight)
      }

      ctx.closePath();
      ctx.stroke();
      ctx.restore();
    }
  }
  init()
</script>